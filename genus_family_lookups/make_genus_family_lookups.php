<?php

////////////////////////////////////////////////////////////////////////
// Purpose:
// Creates new tables `family_acceptedFamily_lookup` and `genus_family_lookup`
// The former contains family-acceptedFamily transformations for fully 
// synonymous families (such as Compositae-->Asteraceae). 
// The latter contains all unique combinations of genus+family 
// classifications, according to GRIN taxonomy
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
// Load parameters file. Check it!
////////////////////////////////////////////////////////////////////////

include "params.inc";

////////////////////////////////////////////////////////////////////////
// Confirm operation
////////////////////////////////////////////////////////////////////////

echo "Building genus-family lookup tables:\r\n\r\n";

////////////////////////////////////////////////////////////////////////
// Download and unzip files from ftp site
// If tables have already been downloaded and you do not need to refresh, 
// set parameter $download to false in params.inc
// Files MUST be present if download==false
////////////////////////////////////////////////////////////////////////

if ($download){
	include "download_gf.inc";
}

///////////////////////////////////////////////////////////////////
// Create database, dropping previous database if exists
// This is why I used the over-specific variable name DB_GRIN
// To dangerous to use the generic 'DB'
///////////////////////////////////////////////////////////////////

include "drop_gf_database.inc";
include "create_gf_database.inc";

///////////////////////////////////////////////////////////////////
// Connect to new database
///////////////////////////////////////////////////////////////////

$sql="USE $DB_NEW;";
sql_execute_multiple($dbh, $sql);

///////////////////////////////////////////////////////////////////
// Create grin taxonomy tables
///////////////////////////////////////////////////////////////////

// Create tables
echo "Creating grin taxonomy tables...";
include "sql_create_grin_taxonomy_tables.inc";
if (sql_execute_multiple($dbh, $sql_create_grin_taxonomy_tables));
echo $msg_success;

///////////////////////////////////////////////////////////////////
// Load data from text files to raw data tables in new MySQL DB
///////////////////////////////////////////////////////////////////

// Import data from dump files into the raw tables
include "import_gf.inc";

////////////////////////////////////////////////////////////////////////
// Create family_acceptedFamily lookup table
////////////////////////////////////////////////////////////////////////

echo "Creating table `$faf`...";
include "sql_create_faf_lookup_table.inc";
sql_execute_multiple($dbh, $sql_create_faf_lookup_table);
echo $msg_success;

////////////////////////////////////////////////////////////////////////
// Populate family_acceptedFamily lookup table
////////////////////////////////////////////////////////////////////////

include "populate_faf_lookup.inc";

////////////////////////////////////////////////////////////////////////
// Create family-genus table
////////////////////////////////////////////////////////////////////////

echo "Creating table `$fg`...";
include "sql_create_gf_lookup_table.inc";
sql_execute_multiple($dbh, $sql_create_gf_lookup_table);
echo $msg_success;

////////////////////////////////////////////////////////////////////////
// Populate genus_family_lookup table
// Adds all unique genus+family combinations from GRIN Taxonomy
// genus table
////////////////////////////////////////////////////////////////////////

include "populate_gf_lookup.inc";

////////////////////////////////////////////////////////////////////////
// Transfer lookup tables
////////////////////////////////////////////////////////////////////////

include "transfer_tables.inc";

////////////////////////////////////////////////////////////////////////
// Remove temporary database if requested in parameters
////////////////////////////////////////////////////////////////////////

if ($drop_db_on_finish){
	include "drop_gf_database.inc";
}

// reset database connection
$sql="USE $DB;";
sql_execute_multiple($dbh, $sql);


?>
